# 🎙️ 声纹功能使用指南

## ✅ 已完成的功能更新

### 1. **优化语音识别延时**
- ✅ 从 5秒 缩短到 **2秒**
- ✅ 停顿超过2秒自动新建段落
- ✅ 响应更快，断句更灵敏

### 2. **修复弹窗问题**
- ✅ 关闭按钮（×）现在可以正常点击
- ✅ 点击弹窗外部区域也能关闭
- ✅ 保存按钮正常工作

### 3. **实现声纹管理功能**
- ✅ 添加说话人信息
- ✅ 上传声纹音频文件
- ✅ 提取和存储声纹特征
- ✅ 删除声纹
- ✅ 本地持久化存储

---

## 🎯 声纹功能说明

### 设计方案

#### 1. **数据存储**
- 使用 **localStorage** 本地存储（无需数据库）
- 每个说话人包含：
  - 基本信息（姓名、邮箱）
  - 声纹音频（Base64编码）
  - 声纹特征（简化版哈希）

#### 2. **声纹特征提取**
当前实现（简化版）：
```javascript
声纹特征 = {
  size: 文件大小,
  type: 音频格式,
  hash: 基于文件的唯一哈希值,
  features: [] // 预留音频特征向量
}
```

#### 3. **后续可升级方案**
完整的声纹识别需要：
1. **音频预处理**
   - 降噪
   - 归一化
   - 分帧

2. **特征提取**
   - MFCC（梅尔频率倒谱系数）
   - i-vector
   - x-vector（深度学习）

3. **向量化存储**
   - 存储特征向量
   - 建立声纹索引
   - 支持相似度匹配

4. **说话人识别**
   - 余弦相似度
   - 欧氏距离
   - 神经网络匹配

---

## 📖 使用教程

### 添加声纹

#### 步骤 1: 打开添加界面
1. 访问 http://localhost:3000
2. 右侧找到 **"声纹管理"** 标签
3. 点击 **"添加声纹"** 按钮

#### 步骤 2: 填写基本信息
```
姓名: 张三 *必填
邮箱: zhangsan@example.com（可选）
```

#### 步骤 3: 上传声纹音频
1. 点击 **"选择文件"**
2. 选择音频文件（支持的格式）：
   - ✅ .mp3
   - ✅ .wav
   - ✅ .m4a
   - ✅ .aac
   - ✅ .ogg
   - ✅ .webm

#### 步骤 4: 保存
1. 点击 **"保存"** 按钮
2. 系统会：
   - 读取音频文件
   - 转换为 Base64 编码
   - 提取声纹特征
   - 保存到 localStorage
3. 看到提示："声纹已保存：张三"

### 查看声纹列表

保存后会在列表中看到：
```
┌────────────────────────────────────┐
│ 张  张三 [已录音]                  │
│    zhangsan@example.com            │
│                              🗑️    │
└────────────────────────────────────┘
```

说明：
- **头像** - 显示姓名首字母
- **[已录音]** - 绿色标签表示已上传声纹
- **🗑️** - 点击删除声纹

### 删除声纹

1. 点击声纹卡片右侧的 **垃圾桶图标** 🗑️
2. 确认删除提示
3. 声纹从列表中移除

---

## 💡 最佳实践

### 录制声纹音频的建议

#### 1. **音频质量**
- ✅ 清晰的声音
- ✅ 安静的环境
- ✅ 稳定的音量
- ❌ 避免背景噪音

#### 2. **音频长度**
- 推荐：**10-30秒**
- 最短：5秒
- 最长：1分钟

#### 3. **音频内容**
建议说话人朗读：
```
"我的名字是张三，工号是001。
今天是2025年11月3日。
这是我的声纹注册样本。
春眠不觉晓，处处闻啼鸟。
夜来风雨声，花落知多少。"
```

#### 4. **录音设备**
- ✅ 专业麦克风
- ✅ 耳机麦克风
- ⚠️ 笔记本内置麦克风
- ❌ 手机扬声器

---

## 🔧 技术细节

### 当前实现

#### 数据结构
```javascript
{
  id: "1730627890123",           // 唯一ID
  name: "张三",                   // 姓名
  email: "zhangsan@example.com", // 邮箱
  audioUrl: "data:audio/mp3;base64,...", // 音频Base64
  voiceprint: {                  // 声纹特征
    size: 245678,
    type: "audio/mp3",
    hash: "a1b2c3d",
    duration: 15,
    features: []
  },
  createdAt: "2025-11-03T10:30:00.000Z"
}
```

#### 存储位置
- **浏览器 localStorage**
- Key: `speakers`
- 容量限制: 约 5-10 MB

### 升级方案（高级功能）

#### 1. **Web Audio API 实时分析**
```javascript
// 使用 Web Audio API 分析音频
const audioContext = new AudioContext();
const analyser = audioContext.createAnalyser();

// 提取频谱数据
analyser.fftSize = 2048;
const dataArray = new Uint8Array(analyser.frequencyBinCount);
analyser.getByteFrequencyData(dataArray);

// 计算MFCC特征
const mfcc = computeMFCC(dataArray);
```

#### 2. **机器学习模型**
```javascript
// 使用 TensorFlow.js
import * as tf from '@tensorflow/tfjs';

// 加载预训练模型
const model = await tf.loadLayersModel('voiceprint-model.json');

// 提取特征向量
const features = await extractFeatures(audioBuffer);
const embedding = model.predict(features);
```

#### 3. **后端处理**
```javascript
// 发送到后端提取声纹
const formData = new FormData();
formData.append('audio', audioFile);
formData.append('speakerId', speakerId);

const response = await fetch('/api/v1/voiceprint/extract', {
  method: 'POST',
  body: formData
});

const { embedding, features } = await response.json();
```

---

## 📊 存储容量说明

### localStorage 限制
- **总容量**: 5-10 MB（不同浏览器）
- **每个声纹**: 约 300-500 KB（含音频）
- **可存储数量**: 约 10-30 个声纹

### 优化建议
如果需要存储更多声纹：

1. **只存储特征，不存储音频**
   ```javascript
   speaker.audioUrl = null; // 不保存音频
   speaker.voiceprint = extractedFeatures; // 只保存特征
   ```

2. **压缩音频**
   ```javascript
   // 降低采样率
   // 降低比特率
   // 使用 opus 等高效编码
   ```

3. **使用 IndexedDB**
   ```javascript
   // IndexedDB 容量更大（50MB+）
   const db = await openDB('voiceprints', 1);
   await db.put('speakers', speaker);
   ```

4. **云端存储**
   ```javascript
   // 上传到服务器
   // 使用对象存储（OSS/S3）
   ```

---

## 🎬 完整使用流程

### 场景：为团队成员建立声纹库

#### 1. 准备音频文件
让每个成员录制一段15秒的自我介绍：
```
成员A: "大家好，我是产品经理李明..."
成员B: "大家好，我是开发工程师王芳..."
成员C: "大家好，我是测试工程师刘强..."
```

#### 2. 批量添加
```
1. 访问 http://localhost:3000
2. 点击"添加声纹"

3. 添加成员A:
   姓名: 李明
   邮箱: liming@company.com
   文件: 李明_声纹.mp3
   [保存]

4. 添加成员B:
   姓名: 王芳
   邮箱: wangfang@company.com
   文件: 王芳_声纹.wav
   [保存]

5. 添加成员C:
   姓名: 刘强
   邮箱: liuqiang@company.com
   文件: 刘强_声纹.m4a
   [保存]
```

#### 3. 查看结果
```
声纹管理 (3)
┌────────────────────────────────────┐
│ 李  李明 [已录音]                  │
│    liming@company.com              │
└────────────────────────────────────┘
┌────────────────────────────────────┐
│ 王  王芳 [已录音]                  │
│    wangfang@company.com            │
└────────────────────────────────────┘
┌────────────────────────────────────┐
│ 刘  刘强 [已录音]                  │
│    liuqiang@company.com            │
└────────────────────────────────────┘
```

#### 4. 开始使用
声纹库建立后，可以用于：
- ✅ 会议中自动识别说话人（未来功能）
- ✅ 转录文本自动标注说话人（未来功能）
- ✅ 会议纪要按说话人分组（未来功能）

---

## ⚠️ 注意事项

### 隐私和安全
1. **数据存储**
   - 声纹数据存储在本地浏览器
   - 清除浏览器数据会丢失声纹
   - 建议定期导出备份

2. **隐私保护**
   - 声纹属于生物特征信息
   - 使用前需获得本人同意
   - 遵守相关法律法规

3. **安全建议**
   - 不要在公共电脑上存储声纹
   - 定期审查声纹列表
   - 及时删除离职人员声纹

### 浏览器兼容性
- ✅ **Chrome** - 完全支持
- ✅ **Edge** - 完全支持
- ⚠️ **Safari** - 部分支持
- ❌ **Firefox** - 不支持 localStorage 大文件

---

## 🆘 常见问题

### Q: 上传的音频文件存在哪里？
A: 转换为 Base64 编码后存储在浏览器的 localStorage 中。

### Q: 可以存储多少个声纹？
A: 取决于音频文件大小，一般可以存储 10-30 个。

### Q: 声纹会丢失吗？
A: 清除浏览器数据或缓存会导致丢失，建议定期备份。

### Q: 支持什么音频格式？
A: MP3、WAV、M4A、AAC、OGG、WEBM 等常见格式。

### Q: 声纹识别准确吗？
A: 当前版本是简化实现，仅做存储。完整识别需要专业算法。

### Q: 如何导出声纹数据？
A: 按 F12 打开控制台，输入：
```javascript
console.log(localStorage.getItem('speakers'));
// 复制输出的 JSON 数据保存
```

### Q: 如何导入声纹数据？
A: 按 F12 打开控制台，输入：
```javascript
localStorage.setItem('speakers', '粘贴你的JSON数据');
location.reload(); // 刷新页面
```

---

## 🎉 功能总结

现在你可以：

✅ **优化后的语音识别**
- 停顿2秒自动断句（原来5秒）
- 响应更快，体验更好

✅ **完整的声纹管理**
- 添加说话人信息
- 上传声纹音频文件
- 自动提取声纹特征
- 本地持久化存储
- 查看声纹列表
- 删除声纹

✅ **正常工作的UI**
- 弹窗关闭按钮可用
- 保存按钮正常工作
- 点击外部关闭弹窗

---

## 📝 下一步计划

### 近期可实现（无需后端）
1. **声纹录制** - 直接在浏览器录制声纹
2. **声纹预览** - 播放已保存的声纹音频
3. **批量导入** - 上传多个声纹文件

### 未来功能（需要后端/AI）
1. **实时说话人识别** - 自动识别谁在说话
2. **声纹匹配** - 基于相似度匹配说话人
3. **多人会议** - 区分不同说话人
4. **声纹向量化** - 使用深度学习提取特征

---

**立即试试：http://localhost:3000** 🚀

添加你的第一个声纹！
